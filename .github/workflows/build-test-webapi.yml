name: Build, test and run project 

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - edited
      - reopened
      - synchronize

jobs:
    build-and-test-backend:
        runs-on: ubuntu-latest
        permissions:
          checks: write      # Required for dorny/test-reporter
          pull-requests: write # Optional: to post comments if configured
          contents: read     # Required to checkout code


        steps:
        - name: Checkout code
          uses: actions/checkout@v2

        - name: Set up .NET Core
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: '8.0.x'

        - name: Install API dependencies
          run: dotnet restore
          working-directory: ./blotztask-api

        - name: Install test dependencies
          run: dotnet restore
          working-directory: ./blotztask-test

        - name: .Net - Tool restore
          working-directory: ./blotztask-api
          run: |
            dotnet tool restore

        - name: Build the API project
          run: dotnet build --configuration Release --no-restore
          working-directory: ./blotztask-api

        - name: Build the test project
          run: dotnet build --configuration Release --no-restore
          working-directory: ./blotztask-test

        - name: Run tests
          run: dotnet test --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test_results.trx" --results-directory ./TestResults
          working-directory: ./blotztask-test

        - name: Test Report
          uses: dorny/test-reporter@v1
          if: success() || failure()    # Run even if tests fail
          with:
            name: .NET Test Results
            path: '**/TestResults/*.trx'
            reporter: dotnet-trx


        - name: Publish the project
          run: dotnet publish -c Release -o ${{ runner.temp }}/blotztask-api
          working-directory: ./blotztask-api

        - name: Generate EF Core migration script
          working-directory: ./blotztask-api
          run: dotnet ef migrations script -o ${{ runner.temp }}/migrations.sql