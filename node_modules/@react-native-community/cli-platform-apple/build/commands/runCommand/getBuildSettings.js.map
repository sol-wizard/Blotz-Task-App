{"version":3,"file":"getBuildSettings.js","names":["getBuildSettings","xcodeProject","mode","buildOutput","scheme","target","buildSettings","child_process","execFileSync","isWorkspace","name","getPlatformName","encoding","settings","JSON","parse","applicationTargets","filter","setting","WRAPPER_EXTENSION","map","settingsTarget","length","selectedTarget","includes","logger","info","pico","bold","targetIndex","indexOf","platformNameMatch","exec","CLIError"],"sources":["../../../src/commands/runCommand/getBuildSettings.ts"],"sourcesContent":["import {CLIError, logger} from '@react-native-community/cli-tools';\nimport {IOSProjectInfo} from '@react-native-community/cli-types';\nimport pico from 'picocolors';\nimport child_process from 'child_process';\n\nexport type BuildSettings = {\n  TARGET_BUILD_DIR: string;\n  INFOPLIST_PATH: string;\n  EXECUTABLE_FOLDER_PATH: string;\n  FULL_PRODUCT_NAME: string;\n};\n\nexport async function getBuildSettings(\n  xcodeProject: IOSProjectInfo,\n  mode: string,\n  buildOutput: string,\n  scheme: string,\n  target?: string,\n): Promise<BuildSettings | null> {\n  const buildSettings = child_process.execFileSync(\n    'xcodebuild',\n    [\n      xcodeProject.isWorkspace ? '-workspace' : '-project',\n      xcodeProject.name,\n      '-scheme',\n      scheme,\n      '-sdk',\n      getPlatformName(buildOutput),\n      '-configuration',\n      mode,\n      '-showBuildSettings',\n      '-json',\n    ],\n    {encoding: 'utf8'},\n  );\n\n  const settings = JSON.parse(buildSettings);\n\n  // Find all 'app' targets in the build settings\n  const applicationTargets = settings\n    .filter((setting: any) => setting.buildSettings.WRAPPER_EXTENSION === 'app')\n    .map(({target: settingsTarget}: any) => settingsTarget);\n\n  if (applicationTargets.length === 0) return null;\n\n  let selectedTarget = applicationTargets[0];\n\n  if (target) {\n    if (!applicationTargets.includes(target)) {\n      logger.info(\n        `Target ${pico.bold(target)} not found for scheme ${pico.bold(\n          scheme,\n        )}, automatically selected target ${pico.bold(selectedTarget)}`,\n      );\n    } else {\n      selectedTarget = target;\n    }\n  }\n\n  const targetIndex = applicationTargets.indexOf(selectedTarget);\n  return settings[targetIndex].buildSettings;\n}\n\nfunction getPlatformName(buildOutput: string) {\n  // Xcode can sometimes escape `=` with a backslash or put the value in quotes\n  const platformNameMatch = /export PLATFORM_NAME\\\\?=\"?(\\w+)\"?$/m.exec(\n    buildOutput,\n  );\n  if (!platformNameMatch) {\n    throw new CLIError(\n      'Couldn\\'t find \"PLATFORM_NAME\" variable in xcodebuild output. Please report this issue and run your project with Xcode instead.',\n    );\n  }\n  return platformNameMatch[1];\n}\n"],"mappings":";;;;;;AAAA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAEA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;EAAA;EAAA;AAAA;AAA0C;AASnC,eAAeA,gBAAgB,CACpCC,YAA4B,EAC5BC,IAAY,EACZC,WAAmB,EACnBC,MAAc,EACdC,MAAe,EACgB;EAC/B,MAAMC,aAAa,GAAGC,wBAAa,CAACC,YAAY,CAC9C,YAAY,EACZ,CACEP,YAAY,CAACQ,WAAW,GAAG,YAAY,GAAG,UAAU,EACpDR,YAAY,CAACS,IAAI,EACjB,SAAS,EACTN,MAAM,EACN,MAAM,EACNO,eAAe,CAACR,WAAW,CAAC,EAC5B,gBAAgB,EAChBD,IAAI,EACJ,oBAAoB,EACpB,OAAO,CACR,EACD;IAACU,QAAQ,EAAE;EAAM,CAAC,CACnB;EAED,MAAMC,QAAQ,GAAGC,IAAI,CAACC,KAAK,CAACT,aAAa,CAAC;;EAE1C;EACA,MAAMU,kBAAkB,GAAGH,QAAQ,CAChCI,MAAM,CAAEC,OAAY,IAAKA,OAAO,CAACZ,aAAa,CAACa,iBAAiB,KAAK,KAAK,CAAC,CAC3EC,GAAG,CAAC,CAAC;IAACf,MAAM,EAAEgB;EAAmB,CAAC,KAAKA,cAAc,CAAC;EAEzD,IAAIL,kBAAkB,CAACM,MAAM,KAAK,CAAC,EAAE,OAAO,IAAI;EAEhD,IAAIC,cAAc,GAAGP,kBAAkB,CAAC,CAAC,CAAC;EAE1C,IAAIX,MAAM,EAAE;IACV,IAAI,CAACW,kBAAkB,CAACQ,QAAQ,CAACnB,MAAM,CAAC,EAAE;MACxCoB,kBAAM,CAACC,IAAI,CACR,UAASC,qBAAI,CAACC,IAAI,CAACvB,MAAM,CAAE,yBAAwBsB,qBAAI,CAACC,IAAI,CAC3DxB,MAAM,CACN,mCAAkCuB,qBAAI,CAACC,IAAI,CAACL,cAAc,CAAE,EAAC,CAChE;IACH,CAAC,MAAM;MACLA,cAAc,GAAGlB,MAAM;IACzB;EACF;EAEA,MAAMwB,WAAW,GAAGb,kBAAkB,CAACc,OAAO,CAACP,cAAc,CAAC;EAC9D,OAAOV,QAAQ,CAACgB,WAAW,CAAC,CAACvB,aAAa;AAC5C;AAEA,SAASK,eAAe,CAACR,WAAmB,EAAE;EAC5C;EACA,MAAM4B,iBAAiB,GAAG,qCAAqC,CAACC,IAAI,CAClE7B,WAAW,CACZ;EACD,IAAI,CAAC4B,iBAAiB,EAAE;IACtB,MAAM,KAAIE,oBAAQ,EAChB,iIAAiI,CAClI;EACH;EACA,OAAOF,iBAAiB,CAAC,CAAC,CAAC;AAC7B"}